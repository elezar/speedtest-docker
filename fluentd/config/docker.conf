<source>
  type forward
  port 24224
  bind 0.0.0.0
</source>

<filter speedtest.*>
  @type parser
  format json
  key_name log
  # reserve_data true
</filter>

<filter speedtest.*>
  @type record_transformer
  <record>
    id "${tag_parts[1]}"
  </record>
  remove_keys "share"
</filter>


<match speedtest.*>
  @type copy
  <store>
    @type stdout
  </store>

  <store>
    @type google_cloud

    use_metadata_service false
    vm_id "#{ENV['HOST_ID']}"
    zone "#{ENV['HOST_ZONE']}"

  </store>

  # <store>
  #   @type bigquery

  #   method insert

  #   auth_method application_default
  #   # json_key /fluentd/etc/speedtest-fluentd.json
  #   # auth_method private_key
  #   # email fluentd@speedtest-lezar.iam.gserviceaccount.com
  #   # private_key_passphrase notasecret
  #   # private_key_path /fluentd/etc/speedtest-063595ecb17b.p12

  #   project speedtest-lezar
  #   dataset speeds_test
  #   table speeds
  #   auto_create_table true
  #   schema_path /fluentd/etc/bq-schema.json
  #   ignore_unknown_values true



  #   # fetch_schema false
  #   # <inject>
  #   #   time_key timestamp
  #   #   time_type string
  #   #   time_format "%Y-%m-%dT%H:%M:%S.%L%Z"
  #   # </inject>
  # </store>
</match>
